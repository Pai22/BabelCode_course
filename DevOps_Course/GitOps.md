# GitOps คืออะไร

GitOps เป็นกรอบการทำงานที่รวมเอาทฤษฎีของ DevOps มาใช้งานด้วยการผสานเข้ากับ Git โดยมีรูปแบบในการจัดการผ่าน Git ในฐานะที่เป็นแหล่งเก็บข้อมูลสำคัญ GitOps เน้นการประกาศการทำงานของส่วนต่าง ๆ ในรูปแบบของ Declarative (เขียนคำสั่งในลักษณะของการตั้งค่าว่าปลายทางต้องการผลลัพธ์ใด) มากกว่าการสร้างชุดคำสั่งหลายขั้นตอนที่มีลักษณะยาวและยากต่อการทำความเข้าใจ การตั้งค่าต่าง ๆ ของระบบ เช่น Infrastructure การทำงานของ Kubernetes ขั้นตอนของ CI/CD ทุกอย่างล้วนจัดเก็บเป็นค่าคอนฟิคในลักษณะของโค้ดแบบ Declarative ใน Git Repository

1. **ทำไม GitOps จึงจำเป็น**
การใช้งาน GitOps นำมาซึ่งประโยชน์ที่หลากหลายดังต่อไปนี้

- **ทำให้การ Deploy ซอฟต์แวร์ดีกว่าเดิม**: GitOps ใช้รูปแบบการ Deploy โค้ดแบบอัตโนมัติจึงสะดวก รวดเร็ว และป้องกันความผิดพลาดได้มากกว่า
- **ทำให้การกู้คืนระบบจากข้อผิดพลาดเป็นไปอย่างรวดเร็ว**: พื้นฐานของ GitOps เริ่มจากการใช้งาน Git เราจึงสามารถใช้คำสั่ง git revert เพื่อย้อนการทำงานได้ ภายหลังกระบวนการดังกล่าวขั้นตอนการ Deploy สู่โค้ดเก่าจะเกิดขึ้นโดยอัตโนมัติ
- **มีการจัดการข้อมูลความลับหรือ Credentials ที่ดีกว่าเดิม**: การใช้งาน GitOps ทำให้เราไม่ต้องแยกเก็บ Credentials ในหลากหลายที่ หากแต่สามารถใช้เครื่องมือเพื่อผสานการทำงานอย่างลงตัวกับ Git Repository เพื่อให้การจัดเก็บ Credentials เหล่านั้นมีความปลอดภัยมากขึ้น
- **ขั้นตอนการ Deploy อธิบายได้ด้วยชุดของการตั้งค่า**: จากเดิมที่การ Deploy คือการออกคำสั่งแบบ Manual หรือมีสคริปต์พิเศษที่ช่วยในการทำงาน เมื่อย้ายมาสู่ระบบของ GitOps ขั้นตอนของการ Deploy จะอยู่ในรูปแบบของการตั้งค่าในไฟล์ หากต้องการทราบสถานะปัจจุบันของการ Deploy จึงสามารถดูจากการตั้งค่าดังกล่าวควบคู่ไปกับประวัติการใช้งาน Git ได้
- **ส่งเสริมให้เกิดความรู้สึกเป็นเจ้าของและการแสวงหาความรู้**: เนื่องจาก Git Repository เป็นหัวใจสำคัญสำหรับการจัดเก็บทุกข้อมูลใน GitOps จึงส่งเสริมให้ทีม DevOps รู้สึกเป็นเจ้าของทุกส่วนในโปรเจคอย่างแท้จริง ไม่ใช่เฉพาะบางส่วนที่อยู่ในความดูแลของตน นอกจากนี้การเป็นแหล่งรวมของทุกสรรพสิ่งยังทำให้ผู้คนในทีมเกิดการเรียนรู้ที่จะเข้าใจในเครื่องมือต่าง ๆ ของ GitOps อีกด้วย
2. หลักการของ GitOps
ต่อไปนี้เป็นหลักการสำคัญของ GitOps

- **อธิบายระบบทั้งหมดด้วยวิธีการแบบ Declarative**: แทนที่จะใช้สคริปต์คำสั่งที่เขียนอธิบายทีละขั้นตอนว่าต้องดำเนินการอย่างไรจึงจะได้โครงสร้างของระบบที่สมบูรณ์ GitOps ใช้วิธีการอื่นคือ Declarative ด้วยการประกาศสถานะสุดท้ายที่ต้องการ ส่วนที่เหลือให้เครื่องมือเป็นผู้ดำเนินการสู่สถานะปลายทางนั้นแทนการออกคำสั่งด้วยมือ
- **ใช้ Git เป็นเครื่องมือควบคุมเวอร์ชัน**: เวอร์ชันของการ Deploy ได้รับการควบคุมผ่าน `git commit` หากต้องการย้อนกลับการ Deploy ไปสู่เวอร์ชันก่อนหน้าจึงสามารถใช้ `git revert` ดำเนินการได้
- **การเปลี่ยนแปลงใด ๆ ในระบบเป็นไปอย่างอัตโนมัติโดยอาศัยเครื่องมือ**: เนื่องจากเครื่องมือต่าง ๆ ใน GitOps สามารถเข้าถึง Git Repository ได้ หากเครื่องมือเหล่านั้นเห็นการเปลี่ยนแปลงใน Repository ก็จะทำให้เกิดผลลัพธ์ใหม่ของการเปลี่ยนแปลงโดยอัตโนมัติ
- **สามารถกู้คืนสู่สถานะที่ถูกต้องได้โดยอัตโนมัติและแจ้งเตือนได้เมื่อเกิดสิ่งผิดปกติ**: ตัวอย่างเช่น หากการตั้งค่าระบุให้คอนเทนเนอร์มี 3 replicas กรณีที่มีคนอื่นในทีมไปลบ Pod ออก 1 ตัว ระบบต้องสามารถกู้คืนกลับสู่สถานะเดิมคือ 3 replicas ได้เหมือนเดิม พร้อมกันนี้อาจมีการส่งการแจ้งเตือนไปยังทีมที่เกี่ยวข้องด้วย ด้วยรูปแบบของการกู้คืนสู่สถานะที่ตั้งไว้ใน Git Repository ได้โดยอัตโนมัติ จึงทำให้ Repository เป็นศูนย์รวมที่แท้จริงของค่าสถานะระบบ

3. GitOps Workflow
โดยทั่วไปแล้ว GitOps ประกอบด้วย Git repositories 2 ประเภท คือ **Application Repository** สำหรับการเก็บซอร์จโค้ดการทำงานหลักของแอปพลิเคชันและเป็นจุดเริ่มต้นที่ทำให้เกิดการ build และ **Environment Repository** ที่ทำหน้าที่ในการจัดเก็บค่าการตั้งค่าเกี่ยวกับ Infrastructure

GitOps ประกอบด้วยรูปแบบของการ Deploy สองรูปแบบ ได้แก่ **push model** และ **pull model**

- 3.1 Push Model
![push-model](/DevOps_Course//Images/push-model.png)
Push Model จะทำการส่งมอบทุกสิ่งที่เกิดการเปลี่ยนแปลงใน Repository ไปสู่ Environment ดังนั้นแล้วหากบน Environment นั้นเกิดการแก้ไขค่าโดยผู้ใช้งาน จะทำให้สถานะที่นิยามไว้ในไฟล์ตั้งค่าไม่ตรงกับสิ่งที่เป็นจริงใน Environment ได้ เราจึงควร Monitor การเปลี่ยนแปลงโดยตรงบน Environment ว่าแตกต่างไปจากสถานะที่ตั้งไว้ในไฟล์ตั้งค่าบน Environment Repository หรือไม่ ตัวอย่างเครื่องมือที่ใช้ในรูปแบบของ Push Model เช่น Jenkins, CircleCI, Travis CI และ Github Actions เป็นต้น

- 3.2 Pull Model
![pull-model](/DevOps_Course//Images/pull-model.png)
Pull Model หรือที่เรียกว่า **Agent-based Deployment Model** จะมีการติดตั้งสิ่งที่เรียกว่า Agent ไว้ภายใต้ Environment เพื่อทำหน้าที่ในการ Monitor ค่าของการตั้งค่าใน Environment Repository หากทำการเปรียบเทียบระหว่างสถานะที่ต้องการกับสถานะปัจจุบันใน Environment แล้วเกิดความแตกต่างกัน Agent จะพยายามทำให้ Environment เข้าสู่สถานะตามที่ต้องการโดยอัตโนมัติ ตัวอย่างของเครื่องมือในกลุ่มนี้ เช่น Argo CD เป็นต้น